from common.vlopenaiChat import openaiChatVL

def call_qwen_vl(image_paths, title, text_prompt=None, system=None):
    """
    封装图文多模态模型调用，用于从文档图片中提取或验证标题。
    优化点：优先忽略红色文字，提取黑色/深色正文中的核心标题。
    若模型返回泛化标题（如"情况概要"），则使用原始文件名作为标题。
    Args:
        image_paths (list[str]): 图片文件路径列表。
        title (str): 原始文档标题（通常为文件名）。
        text_prompt (str, optional): 自定义的文本提示。
        system (str, optional): 自定义的系统角色指令。
    Returns:
        str: 提取或回退后的标题（纯净文本）。
    """
    try:
        bot = openaiChatVL()  # 假设能正确初始化
        # --- System Prompt ---
        if system is None:
            system = (
                "你是一位高度专业、严谨的文档图像分析专家，专注于从多页扫描件或截图中精准提取真实存在的文档标题。"
                "你具备强大的视觉理解能力，能够区分文本的颜色、位置和格式。"
                "你的输出将直接影响后续自动化处理，因此必须100%准确、纯净。"
                "**最终输出必须且只能是标题文本本身，不得包含任何分析、说明、前缀或后缀。**"
            )
        # --- Text Prompt (核心优化) ---
        if text_prompt is None:
           text_prompt = f'''
你是一位专业的文档图像分析专家。你的核心任务是根据提供的文档图片，**精准、严格地**提取或验证文档标题。

**输入**:
- 一组文档图片
- 一个"原始文档标题"：{title}

**核心原则 (最高优先级)**:
- **必须完整保留原文中的所有标点符号**（包括中英文的句号、逗号、引号、括号、顿号、冒号、分号、破折号、省略号、书名号、百分号、@、&、*、#、+、-、/、~、`、^、|、\\ 等）。
- **严禁删除、替换或修改任何标点符号**。
- **必须去除所有空格**（包括中英文空格、制表符）和**回车符**。
- **最终输出必须且只能是标题文本本身**，严禁包含任何分析、说明、前缀（如"标题："）、后缀或多余符号。

**⚠️ 极端重要：关于数字与标点的警告 ⚠️**
- **绝对禁止**将标题中的 `数字.数字` 模式（如 `1.3`、`1.1`、`7.6`、`11.1`）合并或修改为 `13`、`11`、`76` 或 `111` 等形式。
- **必须原样保留**此类标点。例如，对于原始标题 `2024.11.1闵行区七宝镇漕宝路32`，模型的输出：
    - ✅ 正确: `2024.11.1闵行区七宝镇曹宝路3299号七宝宝龙广场火灾战评总结` (保留了 `11.1`)
    - ❌ 错误: `2024111闵行区七宝镇曹宝路3299号七宝宝龙广场火灾战评总结` (合并为 `111`)
    - ❌ 错误: `2024.111闵行区七宝镇曹宝路3299号七宝宝龙广场火灾战评总结` (部分合并)
- **将 `11.1` 错误识别为 `111` 是致命错误**，会严重破坏标题的原始含义。

**严格的处理流程**:

### 1. 颜色识别与文本筛选
- **绝对优先忽略红色文本**（包括深红、亮红、标红），它们通常是批注、警示或印章。
- **标题必须来自黑色、深灰色或其他常规颜色的正文文本**。

### 2. 原始标题强匹配
- **检查所有图片（特别是首页）**，寻找与"原始文档标题"**完全一致**的**非红色文本**。
- **如果找到完全匹配项，立即返回该项文本，并停止后续所有处理步骤**。

### 3. 标题智能提取（仅在未强匹配时执行）
- **定位**: 在**第一张图片**中，寻找**第一个**格式醒目（如居中、加粗、字号较大）的**非红色**文本块。
- **提取要求**:
    - **必须是图片中实际存在的完整短语或句子**。
    - **严禁生成、总结、翻译、拼接或使用泛化词汇**。
    - **严禁返回以下任何泛化标题**:
        通知、文件、情况概要、会议纪要、报告、摘要、材料、正文、附件、说明、概要、通报、纪要、工作通知、文件材料、基本情况、一 基本情况、信息概要、内容摘要、工作简报
- **强制回退机制**:
    - **如果提取的标题命中上述泛化标题列表**，**或模型判断其内容含义模糊、不具体**（例如仅含"基本情况"、"信息概要"等），**或提取结果仅为一个孤立的、不包含任何标点的数字**（例如 `111`），则必须放弃该提取结果。
    - **在这些情况下，立即回退并返回"原始文档标题"**。例如，若模型仅返回 `111`，则必须回退。

### 4. 特殊规则：日期与地点拼接（仅在特定条件下执行）
- **触发条件**:
    - **必须同时**在文档中明确找到 `处置日期` 或 `走火日期` 或 `起火日期`，**以及** `处置对象` 或 `走火对象` 或 `起火单（部）` 这两个信息点。
- **提取与拼接规则**:
    1.  在文档中定位最明确、最完整的"日期"和"对象"信息对。
    2.  **必须忽略**案件编号、联系人、电话等无关信息。**当出现案件编号时，必须完全忽略，只拼接下边的处置日期+处置对象，走火日期+走火对象，起火日期+起火对象**。
    3.  **严格日期格式化**: 将找到的日期转换为 `YYYY.MM.DD` 格式 (年.月.日)，确保月份和日期为两位数（不足则补零）。
        -  示例: `2024年2月4日` -> `2024.02.04`
    4.  **严格拼接格式**: 将格式化后的**日期字符串**与**对象字符串**直接**拼接**在一起，**拼接前必须去除对象字符串中的所有空格和回车符**，**但必须完整保留所有标点符号**。
        -  示例: `2020.12.27` + `杨浦区政通路305弄11号2楼` -> `2020.12.27杨浦区政通路305弄11号2楼`
    5.  **如果触发了此特殊规则，则最终必须返回此拼接结果，优先级高于步骤3的常规提取和回退**。

### 5. 最终输出格式（强制性检查）
在完成上述所有步骤后，对即将输出的最终标题进行最后一次检查：
- **只保留标题文本**。
- **再次确认已去除所有空格和回车符**。
- **再次确认已完整保留所有原始标点符号**，**特别是 `数字.数字` 这种关键模式**。
- **返回的标题严禁添加(1)~(9)**

**请严格遵循以上所有规则，分析图片并返回最终结果。**
'''
        # --- 调用模型 ---
        response = bot.openai_generate(image_paths=image_paths, text_prompt=text_prompt, system=system)
        # --- 客户端后处理（保险机制）---
        if response and not response.startswith("ERROR::"):
            cleaned_response = response.strip()
            # 移除常见前缀（如模型可能仍输出"标题："）
            prefixes_to_remove = ["最终标题：", "标题：", "分析：", "结果：", "###", "```", "**", "✅", "❌"]
            for prefix in prefixes_to_remove:
                if cleaned_response.startswith(prefix):
                    cleaned_response = cleaned_response[len(prefix):].strip()
           # --- 优化后处理：只去除空格和回车符，保留标点符号 ---
            import re
            # 1. 去除所有类型的空格 (包括普通空格、制表符、换行符、回车符等)
            #    \s 匹配任何空白字符，包括空格、制表符(\t)、换行符(\n)、回车符(\r)等
            final_title = re.sub(r'\s+', '', cleaned_response)
            # 2. 特别确保去除全角空格 (Unicode \u3000)
            #    虽然 \s 通常包含 \u3000，但显式替换更保险
            final_title = final_title.replace('\u3000', '')
            # --- 新增：强制修正日期格式（将20240224转换为2024.02.24）---
            # 匹配8位连续数字开头的标题
            date_pattern = r'^(\d{8})(.*)'
            match = re.match(date_pattern, final_title)
            if match:
                date_part = match.group(1)  # 如 "20240224"
                rest_part = match.group(2)   # 如 "杨浦区..."
                if len(date_part) == 8:
                    year = date_part[:4]
                    month = date_part[4:6]
                    day = date_part[6:8]
                    # 转换为标准格式
                    corrected_date = f"{year}.{month}.{day}"
                    final_title = corrected_date + rest_part
            # --- 新增：防止返回泛化标题，若命中则回退到原始 title ---
            generic_titles = {
                "通知", "文件", "情况概要", "情况通报", "会议纪要", 
                "报告", "摘要", "材料", "正文", "附件", "说明", 
                "概要", "通报", "纪要", "工作通知", "文件材料"
            }
            # 判断是否为泛化标题（模糊匹配）
            if final_title.strip() in generic_titles:
                print(f"[WARNING] 模型返回泛化标题: '{final_title}'，已回退到原始文件名: '{title}'")
                return title  # 回退到原始文件名
            
            # --- 移除结尾的页码标记 (1) 到 (9) ---
            import re
            # 使用正则表达式匹配并移除结尾的 (1) 到 (9)
            # \($ 表示匹配字符串末尾的 "("
            # [1-9] 匹配数字 1 到 9
            # \) 匹配 ")"
            # $ 表示匹配字符串末尾 (确保括号和数字在最后)
            final_title = re.sub(r'\([1-9]\)$', '', final_title)
            
             # --- 检查标题是否仅为数字或中文数字，若是则回退 ---
            # 1. 检查是否只包含阿拉伯数字
            if final_title.isdigit():
                print(f"[INFO] 模型返回纯数字标题: '{final_title}'，回退到原始文件名: '{title}'")
                return title

            # 2. 检查是否只包含中文数字 (简化版: 零, 一, 二, 三, 四, 五, 六, 七, 八, 九, 十, 〇, 两, 十)
            #    注意: 这个列表可能不完全，根据实际情况可扩展。
            #    为了更鲁棒，我们检查标题是否完全由这些字符组成，且不为空。
            chinese_numerals = set("零一二三四五六七八九十〇两廿卅") # 使用集合提高查找效率
            # 去除空格后的标题字符去重
            final_title_chars = set(final_title.replace(" ", "")) 
            # 检查标题中的所有字符是否都在 chinese_numerals 集合中
            # 并且标题本身不为空
            if final_title_chars and final_title_chars.issubset(chinese_numerals):
                 print(f"[INFO] 模型返回纯中文数字标题: '{final_title}'，回退到原始文件名: '{title}'")
                 return title

            return final_title
        return response
    except Exception as e:
        error_msg = f"调用多模态模型时发生错误: {type(e).__name__}: {str(e)}"
        print(f"[ERROR] {error_msg}")
        return f"ERROR::{error_msg}"