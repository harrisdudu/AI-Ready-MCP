# 问答生成流水线脚本说明手册

## 1. 项目概述

问答生成流水线（QA Generation Pipeline）是一个基于大语言模型（LLM）的自动化问答内容生成系统，能够从给定的文本资料中智能生成高质量的问题和答案对，广泛应用于知识库构建、智能问答系统训练、教育内容开发等场景。

**主要功能特点：**
- 支持多种类型的问题生成（概念型、分析型、应用型）
- 实现完整的问答生成流水线（内容预处理、问题生成、答案生成、问答评估、结果保存）
- 提供批量处理能力，支持高效处理多个文档
- 采用异步处理架构，提高处理效率
- 包含完善的问答质量评估机制
- 支持语义分块，优化长文档处理效果

## 2. 目录结构

```
qa_generation_pipeline/
├── core/
│   ├── prompts.py          # 主要提示词模板定义
│   ├── prompts_auto.py     # 自动问答生成的提示词模板
│   ├── utils.py            # 通用工具函数
│   ├── application_pipeline_batch.py  # 应用型问答生成批量处理流水线
│   └── auto_pipeline_batch.py         # 自动问答生成批量处理流水线
└── 脚本说明手册.md         # 项目说明文档
```

## 3. 核心功能模块

### 3.1 提示词模板系统

提示词模板是整个问答生成系统的核心，定义了问题生成、答案生成和质量评估的具体规则和格式要求。

**主要模板类型：**
- **问题生成模板**：包括概念型问题、分析型问题、应用型问题等多种类型的生成模板
- **答案生成模板**：根据问题类型和文本内容生成准确、全面的答案
- **质量评估模板**：包含完整性、技术性、知识性、准确性、幻觉检测等多项评估指标

**典型模板示例：**
- `concept_question_prompt`：生成聚焦单一概念的精准问题
- `application_question_prompt`：生成侧重于实践和操作的应用类问题
- `evaluate_prompt`：对生成的问答对进行多维度质量评估

### 3.2 文本处理工具集

提供了丰富的文本处理工具函数，支持Markdown文档解析、内容清理、引用处理、文本截断等功能。

**核心工具函数：**
- 文档读取与清理：`read_markdown_file`, `remove_image`, `remove_toc_lines_basic`
- QA内容提取：`extract_items`, `extract_tags_and_content`
- 引用处理：`extract_ref_num`
- 文本截断：`trim_content`
- 页码映射：`create_interval_mapping`, `find_pages_by_range`

### 3.3 批量处理流水线

实现了完整的问答生成流水线，支持批量处理多个文件，包括内容预处理、问题生成、答案生成、问答评估和结果保存等五个主要步骤。

**主要流水线类型：**
- **应用型问答流水线**：专注于生成应用型问题和答案
- **自动问答流水线**：支持多种问题类型的自动生成和处理

### 3.4 异步处理架构

采用异步编程模式，结合线程池和进程池，实现高效的并行处理能力，大幅提升处理效率。

## 4. 主要类和函数说明

### 4.1 BatchBookProcessor类

应用型问答生成的批量处理类，负责协调整个问答生成流水线的执行。

**主要方法：**
- `__init__`：初始化异步客户端、召回系统和处理池
- `process_files`：批量处理文件的主入口，协调整个流水线的执行
- `process_step1`：内容预处理步骤，实现生产者-消费者模式
- `process_step2`：问题生成步骤，使用异步任务队列
- `process_step3`：答案生成步骤，处理每个问题的回答
- `process_step4_evaluate`：问答评估步骤，评估问答对质量
- `process_step5`：结果整理保存步骤，按评分标准筛选并保存结果

### 4.2 BatchAutoProcessor类

自动问答生成的批量处理类，支持多种问题类型的自动生成和处理。

**主要方法：**
- `__init__`：初始化异步客户端、语义分块参数和处理池
- `process_files`：批量处理文件的主入口
- `process_step1`：内容预处理步骤，实现语义分块
- `process_step2`：问题生成步骤，支持多种问题类型
- `process_step3`：答案生成步骤，根据问题类型选择不同提示词
- `process_step4_evaluate`：问答评估步骤
- `process_step5`：结果整理保存步骤

### 4.3 核心辅助函数

- `_generate_questions_for_chunk`：为文本块生成问题
- `_generate_answer_for_question`：为问题生成答案
- `_evaluate_single_qa`：评估单个问答对的质量
- `_call_api_with_retry`：带重试机制的API调用
- `_judge_question_type`：判断问题类型
- `_process_content_helper`：内容处理辅助函数，实现语义分块

## 5. 使用方法

### 5.1 应用型问答流水线使用方法

应用型问答流水线专注于生成应用型问题，适合需要解决实际问题、设计方案等场景。

```python
from qa_generation_pipeline.core.application_pipeline_batch import BatchBookProcessor
import asyncio

# 初始化处理器
processor = BatchBookProcessor(
    model_name="your_model_name",
    api_key="your_api_key",
    thread_num=10,
    process_num=2
)

# 批量处理文件
file_paths = ["path/to/file1.md", "path/to/file2.md"]
output_dir = "path/to/output"
asyncio.run(processor.process_files(file_paths, output_dir))
```

### 5.2 自动问答流水线使用方法

自动问答流水线支持多种问题类型的自动生成，包括概念型、分析型和应用型问题。

```python
from qa_generation_pipeline.core.auto_pipeline_batch import BatchAutoProcessor
import asyncio

# 初始化处理器
processor = BatchAutoProcessor(
    model_name="your_model_name",
    api_key="your_api_key",
    thread_num=10,
    process_num=2
)

# 批量处理文件
file_paths = ["path/to/file1.md", "path/to/file2.md"]
output_dir = "path/to/output"
asyncio.run(processor.process_files(file_paths, output_dir))
```

## 6. 配置说明

### 6.1 模型配置

- `model_name`：使用的LLM模型名称
- `api_key`：API访问密钥
- `base_url`：API基础URL（可选）

### 6.2 处理参数配置

- `thread_num`：线程池大小，控制并发任务数量
- `process_num`：进程池大小，控制并行处理文件数量
- `chunk_size`：文本分块大小（仅自动流水线使用）
- `max_workers`：最大工作协程数量

### 6.3 输出配置

- `output_dir`：结果输出目录
- `min_score`：保存结果的最低评分阈值

## 7. 工作流程

### 7.1 应用型问答流水线工作流程

1. **内容预处理**：读取Markdown文件，清理内容，移除图片、目录等无关信息
2. **问题生成**：使用`application_question_prompt`模板生成应用型问题
3. **答案生成**：使用`application_question_answer_prompt`模板为每个问题生成答案
4. **问答评估**：使用`evaluate_prompt`模板评估问答对质量
5. **结果保存**：按评分标准筛选并保存高质量问答对

### 7.2 自动问答流水线工作流程

1. **内容预处理**：读取Markdown文件，清理内容，进行语义分块
2. **问题类型判断**：判断文本段落适合生成哪种类型的问题
3. **问题生成**：根据判断结果选择合适的提示词模板生成问题
4. **答案生成**：根据问题类型选择对应的提示词模板生成答案
5. **问答评估**：使用`evaluate_prompt_common`模板评估问答对质量
6. **结果保存**：按问题类型和评分标准筛选并保存高质量问答对

## 8. 问答质量评估标准

系统采用多维度的评估指标，确保生成的问答对质量：

### 8.1 主要评估指标

- **完整性（Completeness & Clarity）**：评估问题和答案是否完整、自洽，表述是否清晰
- **技术性（Technical Depth）**：评估问题是否触及技术核心，答案是否体现技术细节
- **知识性（Knowledge & Analysis）**：评估问题是否要求阐释、分析、评价，答案是否体现知识提炼能力
- **准确性（Accuracy & Citation Transparency）**：评估答案是否严格基于原文，引用是否透明
- **幻觉检测（Hallucination Index）**：评估答案中事实性陈述的可验证性
- **难度与推理深度（Difficulty & Reasoning Depth）**：评估问题复杂度和回答所需推理深度

### 8.2 内容分类标签

系统将问答对按内容主题分为四类：
- **防火**：火灾发生前的预防性工作和相关问题
- **灭火**：火灾报警后的应急处置工作和相关问题
- **通用**：支撑防火与灭火体系正常运行的基础性、保障性工作
- **无关**：与消防业务完全无关的内容

## 9. 最佳实践

1. **文档准备**：确保输入文档格式规范，内容清晰，避免包含过多无关信息
2. **参数调优**：根据文档数量和系统性能调整线程数和进程数，平衡效率和资源消耗
3. **质量控制**：设置合理的最低评分阈值，确保输出高质量的问答对
4. **结果审核**：对生成的问答对进行人工审核，特别是对于关键领域的应用
5. **持续优化**：根据实际应用效果，不断调整提示词模板和处理参数

## 10. 注意事项与限制

1. **内容限制**：系统处理效果依赖于输入文档的质量和完整性
2. **幻觉风险**：尽管有幻觉检测机制，但仍可能存在生成内容与原文不完全一致的情况
3. **API依赖**：系统依赖外部LLM API服务，需要确保API可用性和访问权限
4. **资源消耗**：批量处理大量文档时，可能消耗较多的系统资源和API调用配额
5. **伦理合规**：使用系统生成内容时，需确保符合相关法律法规和伦理规范

## 11. 版本信息

- 版本号：1.0.0
- 发布日期：2023年12月
- 主要更新：初始版本，实现基础问答生成功能