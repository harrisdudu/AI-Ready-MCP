# 题目答案分离处理系统 (QA Apart Processing)

## 项目概述

本系统专门处理**题目和答案分离**的传统试卷格式，通过智能识别分界点，将混合文档自动分离为题目部分和答案部分，然后分别提取结构化信息。适用于大多数传统考试试卷的自动化处理。

## 系统架构

```
输入文档 → 分界点识别 → 题目答案分离 → 题目提取 → 答案提取 → 匹配合并 → 输出结果
     ↓           ↓           ↓           ↓         ↓         ↓         ↓
  Markdown   3.1.1_split   questions.md  LLM分析   LLM分析   智能匹配  结构化数据
```

## 核心组件

### 1. 分界点识别器 (`3.1.1_qa_apart_split.py`)

**功能**: 智能识别题目区域和答案区域的分界点

**处理逻辑**:
1. **滑动窗口扫描**: 使用300行窗口，逐页扫描文档
2. **AI智能判断**: 调用大语言模型分析每个窗口内容
3. **分界点定位**: 确定答案区域的起始行号
4. **文档分离**: 根据分界点将文档分为题目和答案两部分

**技术特点**:
- 基于Ark大语言模型的智能分析
- 滑动窗口避免内容截断
- 支持并发处理多个文件
- 详细的错误日志记录

**输出文件**:
```
output_dir/
├── exam_name/
│   ├── questions.md      # 题目部分
│   ├── answers.md        # 答案部分
│   └── report.json       # 处理报告
└── summary.json          # 汇总报告
```

### 2. 题目答案提取器 (`3.1.2_qa_apart.py`)

**功能**: 从分离后的题目和答案文件中提取结构化信息

**处理逻辑**:
1. **题目提取**: 使用滑动窗口分析题目文件，提取四种题型
2. **答案提取**: 分析答案文件，提取题号和对应答案
3. **智能匹配**: 基于题号自动匹配题目和答案
4. **数据验证**: 检查完整性，识别缺失和多余的内容

## 详细处理流程

### 阶段1: 分界点识别

#### 1.1 文档预处理
- 读取Markdown格式的文档内容
- 清理特殊字符和多余的换行符
- 标准化文本格式

#### 1.2 滑动窗口分析
- 使用300行作为一页进行分页处理
- 逐页扫描文档内容，避免一次性加载过大文件
- 为每行添加绝对行号标识

#### 1.3 AI智能判断
- 调用大语言模型分析每个窗口内容
- 判断是否包含题目到答案的分界点
- 如果找到分界点，返回答案区域的起始行号
- 输出包含置信度和判断理由的JSON结果

#### 1.4 分界点确定
- 根据AI识别的分界点位置分离文档
- 分界点之前的内容作为题目部分
- 分界点之后的内容作为答案部分
- 如果没有找到分界点，整个文档作为题目部分

### 阶段2: 题目提取

#### 2.1 滑动窗口处理
- 使用80行作为窗口大小，40行作为步长
- 逐窗口分析文档内容，确保题目完整性
- 避免题目被截断在窗口边界

#### 2.2 题目类型识别
- 识别四种题型：单选题、多选题、判断题、填空题
- 提取题目的关键信息：题号、类型、题干内容
- 确保题目完整性，避免输出不完整的题目
- 支持表格内容的解析

#### 2.3 文本压缩优化
- 压缩多余的空白字符和空行
- 控制单次处理的文本长度，避免超时
- 保持文本的可读性和完整性

### 阶段3: 答案提取

#### 3.1 答案识别规则
- 提取答案的关键信息：题号和答案内容
- 支持多种答案格式：选择题字母、判断题对错、填空题内容
- 确保答案完整性，避免输出不完整的答案
- 处理重复答案，保留唯一答案

#### 3.2 表格内容解析
- 智能识别HTML表格中的答案信息
- 解析表格单元格，提取题号和答案
- 忽略表格中的额外信息（如分数、箭头符号）
- 支持连续题号的批量处理

### 阶段4: 智能匹配

#### 4.1 题号匹配
- 基于题号建立题目和答案的映射关系
- 自动匹配每个题目对应的答案
- 识别缺少答案的题目
- 发现多余的答案信息

#### 4.2 数据完整性检查
- 统计总题目数量
- 记录缺失答案的题号列表
- 记录多余答案的题号列表
- 生成完整的数据质量报告

## 数据结构

### 题目数据结构
- **question_number**: 题目编号（用于匹配答案）
- **question_type**: 题目类型（单选题、多选题、判断题、填空题）
- **question_text**: 完整的题目内容和选项
- **answer**: 标准答案
- **explanation**: 解析说明
- **knowledge_points**: 知识点标签
- **source_file**: 源文件路径
- **source_window**: 题目在源文件中的位置范围

### 输出格式
```json
{
  "exam_name": "考试名称",
  "total_questions": 50,
  "questions": [
    {
      "question_number": 1,
      "question_type": "single",
      "question_text": "题目内容...",
      "answer": "A",
      "explanation": "解析说明...",
      "knowledge_points": "知识点标签"
    }
  ],
  "missing_answers": [25, 30],
  "extra_answers": [51, 52]
}
```

## 使用方法

### 1. 分界点识别
```bash
python 3.1.1_qa_apart_split.py \
  /path/to/input/folder \
  --jsonl-file /path/to/classification_results.jsonl \
  --out-dir /path/to/output \
  --file-concurrency 16 \
  --repeat 3 \
  --timeout 120 \
  --temperature 0.0 \
  --top-p 0.9
```

**参数说明**:
- `folder`: 输入文件夹路径
- `--jsonl-file`: 分类结果JSONL文件，用于筛选符合条件的文件
- `--out-dir`: 输出目录
- `--file-concurrency`: 文件级并发数
- `--repeat`: 每个窗口的重试次数
- `--timeout`: 单次API调用超时时间
- `--temperature`: 模型温度参数
- `--top-p`: 模型top-p参数

### 2. 题目答案提取
```bash
python 3.1.2_qa_apart.py \
  /path/to/split/output \
  --out-dir /path/to/final/output \
  --window-lines 80 \
  --stride-lines 40 \
  --max-workers 8 \
  --temperature 0.0 \
  --top-p 0.9
```

**参数说明**:
- `base_path`: 分界点识别的输出目录
- `--out-dir`: 最终输出目录
- `--window-lines`: 滑动窗口大小
- `--stride-lines`: 窗口步长
- `--max-workers`: 并发处理数量
- `--temperature`: 模型温度参数
- `--top-p`: 模型top-p参数

## 配置要求

### 环境依赖
- Python依赖：tqdm、rich、pandas、volcengine-python-sdk[ark]
- 系统依赖：无特殊要求