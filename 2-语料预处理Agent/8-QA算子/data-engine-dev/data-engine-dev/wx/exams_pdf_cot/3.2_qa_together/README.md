# 题目答案混合处理系统 (QA Together Processing)

## 项目概述

本系统专门处理**题目和答案混合在一起**的现代试卷格式，通过智能抽取和去重处理，从混合文档中提取完整的题目-答案对。适用于现代考试中题目和答案在同一文档的情况，支持多种处理策略和去重机制。

## 系统架构

```
输入文档 → 题目答案提取 → 智能去重 → 依赖关系分析 → 输出结果
     ↓           ↓           ↓           ↓         ↓
  Markdown   滑动窗口分析   语义去重    关系识别    结构化数据
```

## 核心组件

### 1. 无依赖提取器 (`3.2.1_qa_together_without_dep.py`)

**功能**: 从混合文档中直接提取完整的题目-答案对

**处理逻辑**:
1. **滑动窗口扫描**: 使用80行窗口，40行步长扫描文档
2. **AI智能抽取**: 调用大语言模型识别四种题型
3. **完整性检查**: 确保提取的题目和答案完整
4. **并发处理**: 支持多进程并行提取

**技术特点**:
- 基于Ark大语言模型的智能分析
- 滑动窗口避免题目截断
- 支持表格内容的智能解析
- 高效的并发处理机制

**支持的题型**:
- `single`: 单选题
- `multiple`: 多选题
- `judge`: 判断题
- `fill`: 填空题

### 2. 去重处理器 (`3.2.2_deduplicate_alone.py`)

**功能**: 基于语义相似度的智能去重处理

**处理逻辑**:
1. **文本向量化**: 使用本地embedding模型计算文本向量
2. **相似度计算**: 计算所有题目间的余弦相似度
3. **智能去重**: 基于相似度阈值识别重复题目
4. **重复信息记录**: 详细记录重复题目的信息

**技术特点**:
- 本地embedding模型，支持离线处理
- 余弦相似度计算，精确的语义评估
- 可配置相似度阈值（默认0.99）
- 批量处理，高效处理大量数据

### 3. 依赖感知提取器 (`3.2_qa_together_with_dep.py`)

**功能**: 结合语义去重和依赖关系识别的综合处理

**处理逻辑**:
1. **题目提取**: 使用滑动窗口提取题目-答案对
2. **语义去重**: 基于embedding模型进行去重
3. **依赖分析**: 识别题目间的逻辑关联
4. **质量保证**: 多重检查确保数据质量

**高级特性**:
- 语义去重：基于内容相似度而非简单文本匹配
- 依赖关系：识别题目间的逻辑关联
- 质量保证：多重检查确保数据质量
- 灵活配置：可调整相似度阈值和处理参数

## 详细处理流程

### 阶段1: 题目答案提取

#### 1.1 滑动窗口处理
- 使用80行作为窗口大小，40行作为步长
- 逐窗口分析文档内容，确保题目完整性
- 避免题目被截断在窗口边界

#### 1.2 题型识别
- 识别四种题型：单选题、多选题、判断题、填空题
- 提取题目的关键信息：题号、类型、题干、答案、解析
- 确保题目完整性，避免输出不完整的题目
- 支持表格内容的解析

#### 1.3 文本优化
- 压缩多余的空白字符和空行
- 控制单次处理的文本长度，避免超时
- 保持文本的可读性和完整性

### 阶段2: 智能去重

#### 2.1 向量化处理
- 使用本地embedding模型计算文本向量
- 支持批量处理，提升计算效率
- 向量归一化，确保相似度计算的准确性

#### 2.2 相似度计算
- 计算所有题目间的余弦相似度
- 构建相似度矩阵，支持大规模数据处理
- 设置对角线为0，避免自己与自己比较

#### 2.3 去重策略
- 基于相似度阈值识别重复题目
- 保留第一个出现的题目，标记后续重复
- 记录详细的重复信息，便于后续分析

### 阶段3: 依赖关系分析

#### 3.1 逻辑关联识别
- 分析题目间的逻辑依赖关系
- 识别题目序列和分组结构
- 支持复杂的考试逻辑分析

#### 3.2 质量评估
- 评估题目的完整性和准确性
- 检查答案的合理性和一致性
- 生成数据质量报告

## 数据结构

### 题目数据结构
- **qid**: 题目标识符
- **type**: 题目类型（单选题、多选题、判断题、填空题）
- **question**: 完整的题目内容和选项
- **answer**: 标准答案
- **explanation**: 解析说明
- **knowledge_points**: 知识点标签
- **source_window**: 题目在源文件中的位置范围
- **window_local_id**: 窗口内的局部编号
- **source_file**: 源文件路径

### 去重信息结构
- **current_question**: 当前题目内容
- **current_data**: 当前题目数据
- **duplicate_question**: 重复题目内容
- **duplicate_data**: 重复题目数据
- **similarity**: 相似度分数
- **current_index**: 当前题目索引
- **duplicate_index**: 重复题目索引

### 输出格式
```json
{
  "qid": "1",
  "type": "single",
  "question": "题目内容...",
  "answer": "A",
  "explanation": "解析说明...",
  "knowledge_points": "知识点标签",
  "source_window": [1, 80],
  "window_local_id": "1",
  "source_file": "exam.md"
}
```

## 使用方法

### 1. 不带去重
```bash
python 3.2.1_qa_together_without_dep.py \
  /path/to/input/folder \
  --out-dir /path/to/output \
  --window-lines 80 \
  --stride-lines 40 \
  --max-workers 8 \
  --temperature 0.0 \
  --top-p 0.9
```

**参数说明**:
- `input_folder`: 输入文件夹路径
- `--out-dir`: 输出目录
- `--window-lines`: 滑动窗口大小
- `--stride-lines`: 窗口步长
- `--max-workers`: 并发处理数量
- `--temperature`: 模型温度参数
- `--top-p`: 模型top-p参数

### 2. 单独去重
```bash
python 3.2.2_deduplicate_alone.py \
  /path/to/input.jsonl \
  --out-dir /path/to/output \
  --model-path /path/to/embedding/model \
  --similarity-threshold 0.99
```

**参数说明**:
- `input.jsonl`: 输入数据文件
- `--out-dir`: 输出目录
- `--model-path`: embedding模型路径
- `--similarity-threshold`: 相似度阈值

### 3. 带去重
```bash
python 3.2_qa_together_with_dep.py \
  /path/to/input/folder \
  --out-dir /path/to/output \
  --window-lines 80 \
  --stride-lines 40 \
  --max-workers 8 \
  --similarity-threshold 0.85
```

**参数说明**:
- `input_folder`: 输入文件夹路径
- `--out-dir`: 输出目录
- `--window-lines`: 滑动窗口大小
- `--stride-lines`: 窗口步长
- `--max-workers`: 并发处理数量
- `--similarity-threshold`: 相似度阈值

## 配置要求

### 环境依赖
- Python依赖：tqdm、rich、pandas、volcengine-python-sdk[ark]、sentence-transformers
- 系统依赖：无特殊要求

### 模型配置
- **Ark模型**: 需要配置API密钥和模型ID
- **Embedding模型**: 支持本地模型路径或在线模型名称
- **相似度阈值**: 可配置的相似度判断标准

## 性能特点

### 1. 高效处理
- 滑动窗口技术，避免内存溢出
- 并发处理，提升处理速度
- 批量向量化，优化计算效率

### 2. 智能去重
- 语义相似度判断，准确识别重复内容
- 本地模型支持，无需网络依赖
- 可配置阈值，灵活控制去重程度

### 3. 质量保证
- 完整性检查，确保题目完整
- 多重验证，保证数据质量
- 详细日志，便于问题排查

## 应用场景

### 1. 现代考试试卷
- 题目和答案在同一文档的试卷
- 需要智能去重的题库建设
- 复杂逻辑关系的题目分析

### 2. 题库管理
- 大规模题目的去重处理
- 题目质量的智能评估
- 题目关系的自动识别

### 3. 教育培训
- 试题内容的自动提取
- 知识点标签的自动生成
- 题目难度的智能评估

## 注意事项

1. **模型路径**: 确保embedding模型路径正确
2. **相似度阈值**: 根据实际需求调整阈值设置
3. **窗口参数**: 根据文档特点调整窗口大小和步长
4. **并发数量**: 根据系统资源调整并发参数
5. **输出验证**: 定期检查输出数据的质量

